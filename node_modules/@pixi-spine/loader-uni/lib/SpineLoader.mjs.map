{"version":3,"file":"SpineLoader.mjs","sources":["../src/SpineLoader.ts"],"sourcesContent":["import { ISpineResource, SpineLoaderAbstract } from '@pixi-spine/loader-base';\r\nimport { BinaryInput, ISkeletonData, ISkeletonParser, TextureAtlas } from '@pixi-spine/base';\r\nimport * as spine38 from '@pixi-spine/runtime-3.8';\r\nimport * as spine37 from '@pixi-spine/runtime-3.7';\r\nimport * as spine41 from '@pixi-spine/runtime-4.1';\r\nimport { detectSpineVersion, SPINE_VERSION } from './versions';\r\n\r\nclass UniBinaryParser implements ISkeletonParser {\r\n    scale = 1;\r\n\r\n    readSkeletonData(atlas: TextureAtlas, dataToParse: Uint8Array): ISkeletonData {\r\n        let parser: any = null;\r\n        let version = this.readVersionOldFormat(dataToParse);\r\n        let ver = detectSpineVersion(version);\r\n\r\n        if (ver === SPINE_VERSION.VER38) {\r\n            parser = new spine38.SkeletonBinary(new spine38.AtlasAttachmentLoader(atlas));\r\n        }\r\n        version = this.readVersionNewFormat(dataToParse);\r\n        ver = detectSpineVersion(version);\r\n        if (ver === SPINE_VERSION.VER40 || ver === SPINE_VERSION.VER41) {\r\n            parser = new spine41.SkeletonBinary(new spine41.AtlasAttachmentLoader(atlas));\r\n        }\r\n        if (!parser) {\r\n            const error = `Unsupported version of spine model ${version}, please update pixi-spine`;\r\n\r\n            console.error(error);\r\n        }\r\n\r\n        parser.scale = this.scale;\r\n\r\n        return parser.readSkeletonData(dataToParse);\r\n    }\r\n\r\n    readVersionOldFormat(dataToParse: Uint8Array) {\r\n        const input = new BinaryInput(dataToParse);\r\n        let version;\r\n\r\n        try {\r\n            input.readString();\r\n            version = input.readString();\r\n        } catch (e) {\r\n            version = '';\r\n        }\r\n\r\n        return version || '';\r\n    }\r\n\r\n    readVersionNewFormat(dataToParse: Uint8Array) {\r\n        const input = new BinaryInput(dataToParse);\r\n\r\n        input.readInt32();\r\n        input.readInt32();\r\n        let version;\r\n\r\n        try {\r\n            version = input.readString();\r\n        } catch (e) {\r\n            version = '';\r\n        }\r\n\r\n        return version || '';\r\n    }\r\n}\r\n\r\nclass UniJsonParser implements ISkeletonParser {\r\n    scale = 1;\r\n\r\n    readSkeletonData(atlas: TextureAtlas, dataToParse: any): ISkeletonData {\r\n        const version = dataToParse.skeleton.spine;\r\n        const ver = detectSpineVersion(version);\r\n        let parser: any = null;\r\n\r\n        if (ver === SPINE_VERSION.VER37) {\r\n            parser = new spine37.SkeletonJson(new spine37.AtlasAttachmentLoader(atlas));\r\n        }\r\n        if (ver === SPINE_VERSION.VER38) {\r\n            parser = new spine38.SkeletonJson(new spine38.AtlasAttachmentLoader(atlas));\r\n        }\r\n        if (ver === SPINE_VERSION.VER40 || ver === SPINE_VERSION.VER41) {\r\n            parser = new spine41.SkeletonJson(new spine41.AtlasAttachmentLoader(atlas));\r\n        }\r\n        if (!parser) {\r\n            const error = `Unsupported version of spine model ${version}, please update pixi-spine`;\r\n\r\n            console.error(error);\r\n        }\r\n\r\n        parser.scale = this.scale;\r\n\r\n        return parser.readSkeletonData(dataToParse);\r\n    }\r\n}\r\n\r\n/**\r\n * @public\r\n */\r\nexport class SpineLoader extends SpineLoaderAbstract<ISkeletonData> {\r\n    createBinaryParser(): ISkeletonParser {\r\n        return new UniBinaryParser();\r\n    }\r\n\r\n    createJsonParser(): ISkeletonParser {\r\n        return new UniJsonParser();\r\n    }\r\n\r\n    parseData(parser: ISkeletonParser, atlas: TextureAtlas, dataToParse: any): ISpineResource<ISkeletonData> {\r\n        const parserCast = parser as UniBinaryParser | UniJsonParser;\r\n\r\n        return {\r\n            spineData: parserCast.readSkeletonData(atlas, dataToParse),\r\n            spineAtlas: atlas,\r\n        };\r\n    }\r\n}\r\n"],"names":[],"mappings":"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"}